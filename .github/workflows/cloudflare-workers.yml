name: Deploy to Cloudflare Workers

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Typecheck
        run: npm run typecheck

      - name: Ensure KV namespace and patch wrangler.toml
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          python - <<'PY'
          import json
          import os
          import re
          import urllib.request
          
          token = os.environ.get("CLOUDFLARE_API_TOKEN", "")
          account_id = os.environ.get("CLOUDFLARE_ACCOUNT_ID", "")
          if not token or not account_id:
              raise SystemExit("Missing CLOUDFLARE_API_TOKEN or CLOUDFLARE_ACCOUNT_ID")
          
          title = "grok2api-cache"
          base = f"https://api.cloudflare.com/client/v4/accounts/{account_id}/storage/kv/namespaces"
          
          def request(method: str, url: str, data=None):
              headers = {"Authorization": f"Bearer {token}", "Content-Type": "application/json"}
              body = None if data is None else json.dumps(data).encode("utf-8")
              req = urllib.request.Request(url, data=body, headers=headers, method=method)
              with urllib.request.urlopen(req) as resp:
                  return json.loads(resp.read().decode("utf-8"))
          
          ns_id = None
          page = 1
          while True:
              res = request("GET", f"{base}?per_page=100&page={page}")
              if not res.get("success"):
                  raise RuntimeError(res)
              for item in res.get("result", []):
                  if item.get("title") == title:
                      ns_id = item.get("id")
                      break
              if ns_id:
                  break
              info = res.get("result_info") or {}
              if page >= int(info.get("total_pages") or 1):
                  break
              page += 1
          
          if not ns_id:
              res = request("POST", base, {"title": title})
              if not res.get("success"):
                  raise RuntimeError(res)
              ns_id = res["result"]["id"]
          
          path = "wrangler.toml"
          text = open(path, "r", encoding="utf-8").read()
          text2 = re.sub(r'(?m)^id\\s*=\\s*\"REPLACE_WITH_KV_NAMESPACE_ID\"\\s*$', f'id = \"{ns_id}\"', text)
          if text2 == text:
              # allow already-patched config
              pass
          open(path, "w", encoding="utf-8").write(text2)
          print(f"KV namespace ready: {title} ({ns_id})")
          PY

      - name: Apply D1 migrations
        run: npm run db:migrate
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy Worker
        run: npm run deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
